# Blueprint: Cloudflare D1 기반 웹 방치형 RPG

## 1. 개요
Cloudflare D1 데이터베이스와 Cloudflare Pages/Functions를 기반으로 구축된, 현대적이고 확장 가능한 서버리스 웹 방치형 RPG입니다. 이 문서는 게임의 현재 아키텍처, 핵심 기능 및 향후 개발 계획을 정의합니다.

---

## 2. 핵심 아키텍처

- **프론트엔드:** 순수 HTML, CSS, JavaScript로 구성됩니다. 복잡한 프레임워크 없이 웹 표준(Web Components, ES Modules)을 최대한 활용하여 가볍고 빠른 사용자 경험을 제공합니다.

- **백엔드:** Cloudflare Pages Functions를 사용하여 서버리스 API를 구현합니다. 모든 게임 로직과 데이터 처리는 이 Functions 내에서 이루어집니다.

- **데이터베이스:** Cloudflare D1 (SQLite 기반)을 사용하여 모든 게임 데이터를 저장합니다. 백엔드 함수는 Cloudflare 런타임에 내장된 바인딩을 통해 D1과 직접 상호작용하므로, 외부 드라이버나 복잡한 연결 설정이 필요 없습니다.

- **배포:** GitHub 저장소의 `main` 브랜치에 코드를 푸시하면, Cloudflare Pages가 자동으로 빌드 및 배포를 수행하는 CI/CD 파이프라인을 사용합니다.

---

## 3. 현재 구현된 기능

### 3.1. 데이터 관리 (Cloudflare D1)

- **플레이어 테이블 (`players`):**
  - **구조:** `id`, `createdAt`, 각종 스탯 (`stats_maxHp`, `stats_attack` 등), `gold`, `stage` 등 관계형 데이터베이스에 최적화된 형태로 설계되었습니다.
  - **초기화 로직:** API가 처음 호출될 때, 테이블이 존재하는지 확인하고, 존재하지 않으면 자동으로 생성합니다. 또한, 테스트용 플레이어 데이터(`test_player_01`)가 없으면 기본값으로 생성하여 즉시 테스트가 가능하도록 합니다.

### 3.2. 백엔드 API (`/functions/_worker.js`)

- **라우팅:** URL 경로(`/api/getPlayer`, `/api/upgradeStat`)를 기반으로 요청을 처리합니다.
- **`getPlayer` API:** 데이터베이스에서 현재 플레이어의 모든 정보를 조회하여 프론트엔드에 필요한 JSON 형식으로 변환 후 반환합니다.
- **`upgradeStat` API:**
  - URL 쿼리 파라미터(`?stat=...`)로 강화할 스탯의 종류를 받습니다.
  - 플레이어의 현재 골드와 스탯 레벨을 기반으로 강화 비용을 계산합니다.
  - 골드가 충분하면, 스탯을 증가시키고 골드를 차감하는 SQL `UPDATE` 문을 실행합니다.
  - 강화된 후의 최신 플레이어 데이터를 다시 조회하여 반환합니다.

### 3.3. 프론트엔드 (`index.html`, `main.js`, `style.css`)

- **데이터 표시:**
  - 페이지 로드 시, `/api/getPlayer`를 호출하여 서버로부터 받은 데이터로 UI(스탯, 골드, 스테이지 정보 등)를 동적으로 갱신합니다.
- **스탯 강화:**
  - 각 스탯 옆의 'Upgrade' 버튼 클릭 시, 해당 스탯의 이름을 담아 `/api/upgradeStat` API를 호출합니다.
  - 요청이 성공하면, 서버로부터 받은 최신 데이터로 UI를 다시 갱신합니다.
  - 골드가 부족하여 요청이 실패하면, 사용자에게 알림(현재는 `alert`)을 표시합니다.

---

## 4. 진행 중인 작업: 사용자 인증 시스템

- **Google 계정 연동 (OAuth 2.0):** Google 계정을 사용하여 사용자를 인증하고, 고유 ID를 플레이어 데이터의 기본 키로 사용합니다.
- **세션 관리 (JWT):** 로그인 시 암호화된 JWT(JSON Web Token)를 생성하여 `HttpOnly` 쿠키에 저장, 안전한 세션을 유지합니다.
- **멀티 디바이스 로그인 제어:** 데이터베이스에 마지막 세션 토큰의 ID를 기록하여, 가장 최근에 로그인한 기기에서만 API 요청이 가능하도록 제한합니다.

---

## 5. 향후 계획 및 개선점

- **전투 시스템:** 현재는 표현되지 않는 몬스터와의 전투 로직 및 시각적 연출을 구현합니다.
- **장비 시스템:** 장비 획득, 강화, 장착 기능을 추가합니다.
- **오프라인 보상:** 사용자가 접속하지 않은 시간에 대한 보상 로직을 구현합니다.
- **UI/UX 개선:** Web Components를 도입하여 UI를 컴포넌트화하고, 시각적 효과와 애니메이션을 추가하여 게임 경험을 향상시킵니다.
