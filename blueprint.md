# Blueprint: MongoDB 기반 웹 방치형 RPG

## 1. 개요
MongoDB를 데이터베이스로 사용하고, Cloudflare Workers를 백엔드로 활용하는 현대적인 웹 기반 방치형 RPG를 개발합니다. 이 문서는 게임의 아키텍처, 핵심 기능, 시스템 명세 및 개발 로드맵을 정의합니다.

---

## 2. 핵심 아키텍처 원칙

### 2.1. 전체 아키텍처
- **서버 신뢰 (Server-Authoritative) 구조:** 클라이언트(프론트엔드)는 상태 표현과 사용자 입력만 처리합니다. 모든 게임 로직 계산(전투, 보상, 업그레이드 등)은 백엔드에서 수행되며, 클라이언트는 서버의 계산 결과를 신뢰하고 화면에 표시하는 역할만 합니다.
- **Monorepo 권장:** 프론트엔드와 백엔드 간의 타입(Type) 정의를 공유하여 개발 효율성과 안정성을 높입니다.

### 2.2. 프론트엔드 원칙
- **상태 분리:** 서버로부터 받은 데이터 상태(Server State)와 UI를 위한 상태(UI State)를 명확히 분리하여 관리합니다.
- **API 계층 분리:** 서버와 통신하는 API 로직을 별도의 계층으로 분리하여 코드의 재사용성과 유지보수성을 높입니다.
- **전투 연출:** 전투의 실제 결과(승패, 보상)는 서버가 결정합니다. 프론트엔드는 이 결과를 바탕으로 화려한 시각적 "연출"을 담당합니다.

### 2.3. 백엔드 원칙
- **네이티브 MongoDB 드라이버 사용:** Cloudflare Workers 환경에서 `cf-mongodb-polyfills` 라이브러리를 통해 TCP 소켓을 폴리필(polyfill)하여 네이티브 `mongodb` 드라이버를 직접 사용합니다. 이 혁신적인 접근법은 Workers의 제약을 극복하고 데이터베이스와의 직접적인 통신을 가능하게 합니다.
- **로직 분리 (Service/Logic Layer):** 모든 비즈니스 로직은 `Service` 또는 `Logic` 계층에서만 처리합니다. `Controller`(API 엔드포인트 핸들러)는 요청을 받고 응답을 보내는 역할에만 집중하며, 내부에 로직을 포함하지 않습니다.
- **트랜잭션 처리:** 골드 소모, 재료 사용 등 여러 데이터 변경이 동시에 일어나는 `Upgrade`(강화, 합성 등)와 같은 작업은 반드시 네이티브 드라이버가 제공하는 트랜잭션(Transaction)으로 처리하여 데이터 정합성을 보장합니다.
- **오프라인 보상:** 사용자가 접속하지 않은 시간을 계산하여 그에 맞는 보상(골드 등)을 지급하는 로직을 구현합니다.

---

## 3. 계정 및 인증
- **Google 계정 연동:** Google OAuth 2.0을 통해 신규 계정을 생성하고, 로그인/인증을 처리하여 DB와 연동합니다.
- **멀티 디바이스 동시 로그인 제어:** 한 계정으로 여러 기기에서 동시에 접속하는 것을 방지하거나 제어하는 로직을 구현합니다.

---

## 4. 캐릭터 및 성장 시스템

### 4.1. 캐릭터 스탯
- **기본 스탯:** 최대체력, 공격력, 방어력, 치명타율, 공격속도, 회피율
- **DPS 공식:** 캐릭터의 모든 스탯을 종합하여 분당 대미지(DPS)를 계산하는 공식을 만들고 별도 모듈로 분리합니다.

### 4.2. 스탯 강화
- **골드 소모:** 게임 내 재화인 '골드'를 소모하여 각 개별 스탯을 영구적으로 강화할 수 있습니다.

### 4.3. 장비 시스템
- **장비 슬롯:** 무기, 투구, 갑옷, 반지
- **장비 속성:**
    - **슬롯:** 장착 부위 (무기, 투구 등)
    - **등급:** 일반, 고급, 영웅, 전설, 신화
    - **반영 스탯:** 장비 생성 시 공격력, 방어력 등 스탯 중 1개가 랜덤하게 선택됩니다.
    - **반영 수치:** 반영 스탯의 기본 수치
    - **강화 레벨:** 강화를 통해 오르는 레벨
- **장비 관리:**
    - 보유 장비 확인 (인벤토리)
    - 장비 장착/해제 기능 (캐릭터 스탯에 즉시 반영)

### 4.4. 장비 성장
- **강화:**
    - **재료:** 강화석
    - **결과:** 성공 시 강화 레벨 상승 및 반영 수치 증가. 실패 시 재료만 소모.
    - **확률:** 강화 레벨과 무관하게 고정된 성공 확률을 가집니다.
- **합성:**
    - **재료:** 동일한 슬롯과 등급의 장비 여러 개
    - **결과:** 성공 시 상위 등급 장비 1개 획득 (강화 레벨은 초기화). 실패 시 재료만 소모.
    - **확률:** 고정된 성공 확률을 가집니다.
- **각성 (신화 장비 전용):**
    - **조건:** 신화 등급, 동일 장비 1개를 재료로 소모
    - **단계:** 최대 5단계. 각 단계마다 고정된 성공 확률 적용.
    - **효과:** DPS 증가, 보스 대미지 증가 등 각성 레벨별 특수 효과 부여.
- **진화 (신화 장비 전용):**
    - **조건:** 각성 5단계 달성, '진화석' 필요
    - **단계:** 최대 3단계. 각 단계마다 고정된 성공 확률 적용.
    - **효과:** 장비의 '반영 수치'를 큰 폭으로 배수 증가시킵니다.
- **패시브 스킬 트리 (신화 장비 전용):**
    - 각성 및 진화 단계에 따라 활성화되는 선택형 패시브 스킬 트리를 적용합니다.

### 4.5. 확률 공개
- 법적 고지 의무 준수를 위해, 장비 강화, 합성, 각성, 진화, 보스 드롭 등 모든 확률형 콘텐츠의 성공 확률을 유저가 명확히 확인할 수 있는 UI를 구현합니다.

---

## 5. 게임 플레이

### 5.1. 스테이지
- **자동 진행:** 스테이지 클리어 시 다음 스테이지로 자동으로 넘어갑니다.
- **몬스터:** 각 스테이지 레벨에 따라 체력, 공격력 등이 강해지는 몬스터가 등장합니다.
- **클리어 조건:** 스테이지 레벨과 동일한 수의 몬스터를 사냥하면 클리어됩니다.
- **보상:** 스테이지 클리어 시 골드 보상 획득.
- **사망 패널티:** 캐릭터 사망 시, 잠시 후 체력을 모두 회복하고 이전 스테이지에서 자동 부활하여 다시 시작합니다.

### 5.2. 보스 스테이지
- **등장 조건:** 매 10 스테이지마다 보스가 등장합니다.
- **보상:** 보스 사냥 성공 시 장비(일반/고급/영웅 등급 중 랜덤) 1개를 추가로 획득합니다.
- **사망 패널티:** 보스에게 패배 시, 이전 스테이지에서 부활합니다.

### 5.3. 월드 보스 레이드 (시즌제)
- **참여:** 시즌 동안 매일 정해진 횟수만큼 참여 가능합니다.
- **랭킹:** 시즌 동안 월드 보스에게 입힌 누적 피해량으로 기여도 랭킹을 산정합니다.
- **보상:** 시즌 종료 후, 랭킹 순위에 따라 골드, 강화석, 진화석 등 차등 보상을 지급합니다.

---

## 6. UI/UX 및 연출

- **핵심 정보 표시:**
    - 스테이지 진행률 (ProgressBar)
    - 현재 몬스터 HP
    - 현재 캐릭터의 DPS
- **숫자 단위 축약:** 천(K), 백만(M), 십억(B) 등 큰 숫자를 축약하여 표시합니다.
- **서버 동기화:** 30초마다 자동으로 서버와 데이터를 동기화하여 최신 상태를 유지합니다.
- **연출:**
    - **오프라인 보상:** 게임 접속 시, 오프라인 동안 쌓인 보상을 보여주는 팝업 연출.
    - **캐릭터 사망/부활:** 사망 및 부활 시 시각적 연출.
    - **보스전:** "BOSS" 등장 알림 및 보상 획득/사냥 실패 시의 연출.

---

## 7. 보안 및 운영
- **치트 방지:** 서버 신뢰 구조를 바탕으로 메모리 조작, 통신 변조 등 일반적인 치트 행위를 방지하는 로직을 구현합니다.
- **밸런싱 자동화:** 게임 밸런스(스탯, 재화, 성장 곡선 등)를 쉽게 조정하고 시뮬레이션할 수 있는 도구나 시스템을 고려합니다.
